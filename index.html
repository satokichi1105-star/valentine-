<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valentine Surprise</title>
  <style>
    :root{
      --bg1:#0f1020;
      --bg2:#1a1b3a;
      --card:#ffffff12;
      --text:#ffffff;
      --muted:#ffffffb3;
      --yes:#41d18a;
      --no:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif;
      color:var(--text);
      min-height:100vh;
      display:grid;
      place-items:center;
      background: radial-gradient(1200px 600px at 20% 20%, #ff4fd8aa, transparent 60%),
                  radial-gradient(900px 500px at 80% 30%, #4fe7ffaa, transparent 55%),
                  linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }
    .wrap{
      width:min(920px, 92vw);
      padding:18px;
    }
    .card{
      background:var(--card);
      border:1px solid #ffffff22;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      backdrop-filter: blur(10px);
    }
    h1{
      margin:0 0 8px 0;
      font-size: clamp(20px, 4vw, 34px);
      letter-spacing:.02em;
    }
    p{margin:6px 0;color:var(--muted); line-height:1.6}
    .stage{
      margin-top:18px;
      position:relative;
      height: 320px;
      border-radius: calc(var(--radius) + 6px);
      border:1px dashed #ffffff33;
      background: #00000015;
      overflow:hidden;
    }
    .buttons{
      position:absolute;
      inset:0;
      padding:18px;
    }
    .btn{
      position:absolute;
      border:none;
      border-radius:999px;
      padding:14px 18px;
      font-size:18px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
      transition: transform .08s ease;
      touch-action: manipulation;
    }
    .btn:active{ transform: scale(0.98); }
    .yes{ background:var(--yes); color:#0b1a11; }
    .no{ background:var(--no); color:#240b0b; }

    .hud{
      margin-top:12px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border:1px solid #ffffff22;
      border-radius:999px;
      background:#00000018;
      color:var(--muted);
      font-size:14px;
    }
    .msg{
      margin-top:14px;
      display:none;
      gap:14px;
      align-items:center;
      border:1px solid #ffffff22;
      background:#00000020;
      border-radius: var(--radius);
      padding:14px;
    }
    .msg.show{ display:flex; }
    .msg img{
      width:72px;height:72px;object-fit:cover;border-radius:14px;
      border:1px solid #ffffff22;
      flex:0 0 auto;
    }
    .msg .text{
      color:var(--text);
      font-weight:700;
      line-height:1.4;
    }
    .msg .sub{
      color:var(--muted);
      font-weight:500;
      font-size:14px;
      margin-top:2px;
    }

    .videoModal{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.75);
      display:none;
      place-items:center;
      padding:18px;
      z-index:999;
    }
    .videoModal.show{ display:grid; }
    .videoBox{
      width:min(920px, 95vw);
      background:#0b0c16;
      border:1px solid #ffffff22;
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .videoTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid #ffffff18;
      color:var(--muted);
      font-size:14px;
    }
    .close{
      border:none;
      background:#ffffff1a;
      color:var(--text);
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
    }
    video{
      width:100%;
      display:block;
      background:black;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ãƒãƒƒãƒ”ãƒ¼ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ğŸ«</h1>
      <p>ã¡ã‚‡ã£ã¨ã ã‘éŠã‚“ã§ã‹ã‚‰ã€ã‚µãƒ—ãƒ©ã‚¤ã‚ºãŒã‚ã‚‹ã‚ˆã€‚</p>
      <p><strong>è³ªå•ï¼š</strong>ä¿ºã®ã“ã¨â€¦â€¦å¥½ãï¼Ÿ</p>

      <div class="stage" id="stage">
        <div class="buttons" id="buttons">
          <button class="btn yes" id="yesBtn" aria-label="Yes">YES</button>
          <button class="btn no" id="noBtn" aria-label="No">NO</button>
        </div>
      </div>

      <div class="hud">
        <div class="badge" id="counter">YESãŒé€ƒã’ã‚‹å›æ•°ï¼š0</div>
        <div class="badge" id="hint">ãƒ’ãƒ³ãƒˆï¼šYESã‚’æŠ¼ã—ã¦ã­ï¼ˆæŠ¼ã›ãŸã‚‰å‹ã¡ï¼‰</div>
      </div>

      <div class="msg" id="noMsg">
        <img src="no_image.png" alt="ã‹ã‚ã„ã„ç”»åƒ">
        <div>
          <div class="text">ãˆãƒ¼ï¼ã¡ãŒã†ã¡ãŒã†ï¼ğŸ˜‚</div>
          <div class="sub">ã¡ã‚ƒã‚“ã¨YESæŠ¼ã—ã¦ã£ã¦ã€œï¼ˆã»ã‚‰ã€ãŒã‚“ã°ã£ã¦æ•ã¾ãˆã¦ï¼ï¼‰</div>
        </div>
      </div>
    </div>
  </div>

  <div class="videoModal" id="videoModal" role="dialog" aria-modal="true">
    <div class="videoBox">
      <div class="videoTop">
        <div>ğŸ’Œ Surprise</div>
        <button class="close" id="closeBtn">é–‰ã˜ã‚‹</button>
      </div>
      <video id="video" src="video.mp4" playsinline controls></video>
    </div>
  </div>

<script>
(() => {
  // ====== è¨­å®šï¼ˆã“ã“ã ã‘å¥½ã¿ã§å¤‰ãˆã‚Œã°OKï¼‰======
  const ESCAPE_LIMIT = 5;       // YESãŒé€ƒã’ã‚‹å›æ•°ï¼ˆãŠã™ã™ã‚ 5 / ã‚ãªãŸã®æ¡ˆãªã‚‰ 10ï¼‰
  const ESCAPE_PADDING = 12;    // ç«¯ã«å¯„ã‚Šã™ããªã„ä½™ç™½
  const MIN_DISTANCE = 120;     // ã‚«ãƒ¼ã‚½ãƒ«ãŒè¿‘ã¥ã„ãŸã¨åˆ¤å®šã™ã‚‹è·é›¢(px)
  // ==============================================

  const stage = document.getElementById('stage');
  const yesBtn = document.getElementById('yesBtn');
  const noBtn = document.getElementById('noBtn');
  const counter = document.getElementById('counter');
  const hint = document.getElementById('hint');
  const noMsg = document.getElementById('noMsg');

  const modal = document.getElementById('videoModal');
  const video = document.getElementById('video');
  const closeBtn = document.getElementById('closeBtn');

  let escapeCount = 0;
  let yesLocked = false;

  // åˆæœŸé…ç½®
  function placeInitial(){
    const rect = stage.getBoundingClientRect();
    // YESã‚’å³å¯„ã‚Šã€NOã‚’å·¦å¯„ã‚Šã«ç½®ã
    moveBtnTo(yesBtn, rect.width * 0.62, rect.height * 0.52);
    moveBtnTo(noBtn,  rect.width * 0.22, rect.height * 0.52);
  }

  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function moveBtnTo(btn, x, y){
    const s = stage.getBoundingClientRect();
    const b = btn.getBoundingClientRect();
    // stageå†…åº§æ¨™ã«å¤‰æ›ã—ã¦é…ç½®
    const maxX = s.width - b.width - ESCAPE_PADDING;
    const maxY = s.height - b.height - ESCAPE_PADDING;
    const nx = clamp(x - b.width/2, ESCAPE_PADDING, maxX);
    const ny = clamp(y - b.height/2, ESCAPE_PADDING, maxY);
    btn.style.left = nx + 'px';
    btn.style.top  = ny + 'px';
  }

  function randomFarPoint(fromX, fromY){
    const s = stage.getBoundingClientRect();
    const b = yesBtn.getBoundingClientRect();
    const maxX = s.width - b.width - ESCAPE_PADDING;
    const maxY = s.height - b.height - ESCAPE_PADDING;

    // ãªã‚‹ã¹ãã‚«ãƒ¼ã‚½ãƒ«ã‹ã‚‰é›¢ã‚ŒãŸåœ°ç‚¹ã‚’æ•°å›è©¦è¡Œã—ã¦é¸ã¶
    let best = null;
    for(let i=0;i<18;i++){
      const x = ESCAPE_PADDING + Math.random() * (maxX - ESCAPE_PADDING);
      const y = ESCAPE_PADDING + Math.random() * (maxY - ESCAPE_PADDING);
      const dx = (x + b.width/2) - fromX;
      const dy = (y + b.height/2) - fromY;
      const d2 = dx*dx + dy*dy;
      if(!best || d2 > best.d2) best = {x, y, d2};
    }
    return best;
  }

  function updateHud(){
    counter.textContent = `YESãŒé€ƒã’ã‚‹å›æ•°ï¼š${escapeCount}`;
    if (yesLocked){
      hint.textContent = 'OKï¼ä»Šãªã‚‰YESæŠ¼ã›ã‚‹ã‚ˆğŸ˜';
    } else {
      hint.textContent = 'ãƒ’ãƒ³ãƒˆï¼šYESã‚’æŠ¼ã—ã¦ã­ï¼ˆæŠ¼ã›ãŸã‚‰å‹ã¡ï¼‰';
    }
  }

  // YESãŒé€ƒã’ã‚‹å‡¦ç†ï¼ˆãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒä¸¡å¯¾å¿œï¼‰
  function tryEscape(pointerX, pointerY){
    if (yesLocked) return;

    const s = stage.getBoundingClientRect();
    const yRect = yesBtn.getBoundingClientRect();
    // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’stageå†…åº§æ¨™ã¸
    const px = pointerX - s.left;
    const py = pointerY - s.top;

    // YESä¸­å¿ƒã¾ã§ã®è·é›¢
    const cx = (yRect.left - s.left) + yRect.width/2;
    const cy = (yRect.top  - s.top ) + yRect.height/2;
    const dx = cx - px;
    const dy = cy - py;
    const dist = Math.hypot(dx, dy);

    if (dist <= MIN_DISTANCE){
      // é€ƒã’ã‚‹
      escapeCount++;
      if (escapeCount >= ESCAPE_LIMIT){
        yesLocked = true; // ã‚‚ã†é€ƒã’ãªã„
        updateHud();
        return;
      }
      const p = randomFarPoint(px, py);
      moveBtnTo(yesBtn, p.x, p.y);
      updateHud();
    }
  }

  // PC: ãƒã‚¦ã‚¹ç§»å‹•ã§åå¿œ
  stage.addEventListener('mousemove', (e) => {
    tryEscape(e.clientX, e.clientY);
  });

  // ã‚¹ãƒãƒ›: æŒ‡ãŒè¿‘ã¥ã„ãŸã¨ãã‚‚åå¿œï¼ˆtouchmoveï¼‰
  stage.addEventListener('touchmove', (e) => {
    const t = e.touches?.[0];
    if(!t) return;
    tryEscape(t.clientX, t.clientY);
  }, {passive:true});

  // YESã‚¯ãƒªãƒƒã‚¯ï¼šå‹•ç”»å†ç”Ÿ
  yesBtn.addEventListener('click', async () => {
    // é€ƒã’ãŒæ®‹ã£ã¦ã‚‹æ™‚ã«ã‚¯ãƒªãƒƒã‚¯ã§ããŸã‚‰ã€Œå‹ã¡ã€ãªã®ã§ãã®ã¾ã¾é€šã™
    modal.classList.add('show');
    noMsg.classList.remove('show');

    try{
      video.currentTime = 0;
      await video.play(); // ã‚¯ãƒªãƒƒã‚¯èµ·ç‚¹ãªã®ã§è‡ªå‹•å†ç”Ÿåˆ¶é™ã«å¼•ã£ã‹ã‹ã‚Šã«ãã„
    }catch(err){
      // iOSã§ç¨€ã«playãŒå¤±æ•—ã—ãŸã‚‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰‹å‹•å†ç”Ÿã—ã¦ã‚‚ã‚‰ã†
      // controlsã‚’å‡ºã—ã¦ã‚‹ã®ã§OK
    }

    // ã§ãã‚Œã°å…¨ç”»é¢
    try{
      if (video.requestFullscreen) await video.requestFullscreen();
    }catch(e){}
  });

  // NOã‚¯ãƒªãƒƒã‚¯ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‹ç”»åƒ
  noBtn.addEventListener('click', () => {
    noMsg.classList.add('show');

    // ã¡ã‚‡ã£ã¨ãšã¤YESã‚’å¤§ããã—ã¦ã€ŒæŠ¼ã›ã‚‹æ°—ãŒã™ã‚‹ã€æ¼”å‡ºã‚‚å…¥ã‚Œã‚‹ï¼ˆå«Œãªã‚‰æ¶ˆã—ã¦OKï¼‰
    const scale = 1 + Math.min(0.7, escapeCount * 0.06);
    yesBtn.style.transform = `scale(${scale})`;

    // ã¤ã„ã§ã«YESã®é€ƒã’å›æ•°ã‚’1å›é€²ã‚ã‚‹ï¼ˆæŠ¼ã•ã›ã‚‹æ–¹å‘ã¸å¯„ã›ã‚‹æ¼”å‡ºï¼‰
    if (!yesLocked && escapeCount < ESCAPE_LIMIT - 1) {
      escapeCount++;
      updateHud();
    }
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
  function closeModal(){
    modal.classList.remove('show');
    try{ video.pause(); }catch(e){}
  }
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // åˆæœŸåŒ–
  window.addEventListener('resize', placeInitial);
  placeInitial();
  updateHud();
})();
</script>
</body>
</html>
